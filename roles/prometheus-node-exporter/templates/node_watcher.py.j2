#!/usr/bin/env python3
import config
import requests
import socket
import subprocess
import json


bot_key = "{{ watcher_bot_key }}"
g_id = "{{ watcher_g_id }}"
l_dir = "{{ node_exporter_custom_metrics_folder }}"
l_file = "node_metrics.prom"
s_dir = "{{ install_path }}/{{ ton_src }}/scripts/"

# Node diff
def check_diff():
    try:
        dCmnd = s_dir + \
            "check_node_sync_status.sh | grep TIME_DIFF | awk '{print $4}'"
        d = int(subprocess.check_output(dCmnd, shell=True,
                                        executable='/bin/bash', encoding='utf-8'))
        return d
    except:
        tg_notification("Can't get node time diff")

# Telegram notification
def tg_notification(msg):
    botToken = bot_key
    botChatID = g_id
    message = '<b>ALERT!</b> %s!' % msg
    sendText = 'https://api.telegram.org/bot' + botToken + \
        '/sendMessage?chat_id=' + botChatID + '&parse_mode=html&text=' + message
    response = requests.get(sendText)
    return response.json()


if __name__ == '__main__':
    diff = check_diff()
    if diff < -50:
        tg_notification("Diff is" + str(diff))
    
    with open(l_dir + l_file, "w") as text_file:
        text_file.write("node_diff {0}\n".format(diff))